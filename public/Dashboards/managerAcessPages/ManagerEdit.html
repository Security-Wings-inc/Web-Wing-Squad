<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de usuários</title>
    <link rel="stylesheet" href="../cssDashboard/dashboardAdmin.css">
    <link rel="stylesheet" href="../cssDashboard/dashboardSidebarAdmin.css">
    <link rel="shortcut icon" href="../../assets/Vector Security Wings.png" type="image/x-icon">

</head>

<body onload="listarAdmin()">

    <header>


        <div class="lista">

            <ul class="listaHeader">
                <!-- <li><a href="./ManagerEdit.html"><img src="../assetsDashboard/PerfilIcon.svg"
                    style="filter: brightness(0) saturate(100%) invert(59%) sepia(44%) saturate(422%) hue-rotate(149deg) brightness(86%) contrast(86%);"
                    alt=""></a></li> -->

                <!-- <li><a href="./ManagerPage.html"><img
                            src="../assetsDashboard/ChaveIcon.svg" alt=""></a></li> -->
                <li><a href="../managerAcessPages/ManagerPage.html"><img src="../assetsDashboard/SairIcon.svg"
                            alt=""></a></li>
            </ul>

        </div>

    </header>

    <main>

        <div class="contentContainer">

            <div class="containerEsquerdo">

                <div class="titulo" id="titulo">

                    <h1>Tela de Cadastros</h1>
                </div>


                <!-- Botões com todas as opções -->
                <div class="contanierBt" id="btGerais">
                    <p class="texto">
                        Bem vindo, você está no gerenciamento de permissões de usuários da empresa <span
                            id="nomeEmpresa" style="font-weight: bold;"></span>.

                    </p>
                    <button class="botao" id="btCadastrar">

                        <div class="contentBtn">

                            <img src="../assetsDashboard/CadFunc.svg" alt="">
                            <p class="textoBtn">
                                Cadastrar Admin
                            </p>
                        </div>
                    </button>
                </div>


                <!-- Tela de cadastro -->
                <div class="containerInfo" id="cadFuncContainer">


                    <div class="inputContainerCad">
                        <input class="inputInfo" type="text" placeholder="Nome" id="nomeFunc">
                        <input class="inputInfo" type="text" placeholder="CPF" id="cpfFunc">
                        <input class="inputInfo" type="text" placeholder="Email" id="emailFunc">
                        <input class="inputInfo" type="password" placeholder="Senha" id="senhaFunc">
                        <input class="inputInfo" type="password" placeholder="Confirmar Senha"
                            id="senhaFuncConfirm"><br>
                        <button id="cadastrarBt" class="botaoInfo" onclick="cadastrarFunc()"> Cadastrar</button>
                    </div>

                </div>

                <!-- Tela de Editar Usuário -->
                <div class="containerInfo" id="editFuncContainer">


                    <div class="inputContainerEdit">
                        <input class="inputInfo" type="text" placeholder="Email" id="novoEmailIpt">
                        <input class="inputInfo" type="text" placeholder="Senha" id="novaSenhaIpt">
                        <input class="inputInfo" type="text" placeholder="Confirmar Senha">
                        <button id="editarBt" class="botaoInfo" onclick="editarFunc()">Editar</button>
                    </div>

                </div>

                <div class="containerInfo" id="excFuncContainer">

                    <div class="inputContainerExc">
                        <input class="inputInfo" type="text" placeholder="ID do Funcioário">
                        <button id="excluirBt" class="botaoInfo">Excluir</button>
                    </div>

                </div>



                <button id="voltar" class="voltarBt">Voltar</button>





            </div>

            <div class="containerDireito">
                <h1 class="titulo">
                    Lista de Admins da empresa <span id="nomeEmpresaLeftSide" style="font-weight:bold;"></span>
                </h1>

                <div class="listContainer" id="listaUser">
                </div>
            </div>

        </div>


    </main>

    <footer></footer>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>

    var nomeEmpresaSalvo = sessionStorage.NOME_DA_EMPRESA_SALVO;
    nomeEmpresa.innerHTML = `${nomeEmpresaSalvo}`;
    nomeEmpresaLeftSide.innerHTML = `${nomeEmpresaSalvo}`;

    function deletarAdmin(idUser) {
        Swal.fire({
            title: 'Tem certeza?',
            text: 'Ao prosseguir você excluirá permanentemente o usuário',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, excluir usuário!',
            cancelButtonText: 'Cancelar',
        }).then((result) => {

            if (result.isConfirmed) {
                fetch(`/manager/deletarAdmin/${idUser}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    }
                })
                    .then(function (resposta) {
                        console.log("resposta: ", resposta);

                        if (resposta.ok) {
                            Swal.fire(
                                'Sucesso!',
                                'Usuário excluído com sucesso!',
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });

                        } 
                    })
                    .catch(function (resposta) {
                        console.log(`#ERRO: ${resposta}`);
                    });
            }



        })


    }


    function revogarAdmin(idUser) {

        Swal.fire({
            title: 'Tem certeza?',
            text: 'Ao prosseguir você revogará a permissão de admin do funcionário. Clique em "Cancelar" para cancelar a operação.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, revogar!',
            cancelButtonText: 'Cancelar',
        }).then((result) => {
            if (result.isConfirmed) {


                fetch(`/manager/revogarAdmin/${idUser}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    }

                })
                    .then(function (resposta) {
                        console.log("resposta: ", resposta);

                        if (resposta.ok) {
                            Swal.fire(
                                'Sucesso!',
                                'permissão de ADMIN revogada com sucesso',
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });

                        } 
                    })
                    .catch(function (resposta) {
                        console.log(resposta)
                    });
            }
        })




    }



    function listarAdmin() {

        var idEmpresaVar = sessionStorage.ID_EMPRESA_SALVO;

        fetch("/manager/listarAdmin", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresaVar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listarFunc()!")

            if (resposta.ok) {
                console.log(resposta);
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var usuario = resposta[i];

                        var categoria = usuario.isAdmin === 1 ? "admin" : "usuário comum";

                        listaUser.innerHTML += `
                        
                        <div class="contentFunc">
                            <div class="contentfuncEsquerdo">
                                <span>ID: ${usuario.idUsuario}</span>
                                <span>Nome: ${usuario.nome}</span>
                                <span>Email: ${usuario.email}</span>
                                <span>CPF: ${usuario.cpf} </span>
                                <span>Permissão: ${categoria} </span>
                            </div>
                            <div class="contentfuncDireito">
                                <button class="btFunc" onclick="deletarAdmin('${usuario.idUsuario}')"><img src="../assetsDashboard/Lixeira.svg">Excluir</button>
                                <button class="btFunc" onclick="revogarAdmin('${usuario.idUsuario}')"><img src="../assetsDashboard/Revogar.svg">Revogar permissão</button>


                            </div>
                        </div>
                    `;

                    }

                    setTimeout(function () {
                        window.location.reload
                    }, 1000);

                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");
                resposta.text().then(texto => {
                    console.error(texto, "teste");

                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }



</script>