<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de usuários</title>
    <!-- <link rel="stylesheet" href="../cssDashboard/dashboardAdmin.css"> -->
    <link rel="stylesheet" href="../cssDashboard/dashboardTeste.css">
    <link rel="stylesheet" href="../cssDashboard/dashboardSidebarAdmin.css">
    <link rel="shortcut icon" href="../../assets/Vector Security Wings.png" type="image/x-icon">

</head>

<body onload="listarAdmin()">

    <header>


        <div class="lista">

            <ul class="listaHeader">
            
                <li><a href="../../index.html"><img src="../assetsDashboard/SairIcon.svg" alt=""></a></li>
            </ul>

        </div>

    </header>

    <main>

        <div class="contentContainer">

            <div class="containerEsquerdo hide">

                <div class="titulo" id="titulo">

                    <h1>Tela de Cadastros</h1>
                </div>


                <!-- Botões com todas as opções -->
                <div class="contanierBt" id="btGerais">
                    <p class="texto">
                        Bem-vindo à tela de edição de cadastro de usuários da empresa <span id="nomeEmpresa"></span>.
                        Aqui você pode gerenciar as informações dos usuários cadastrados no sistema.
                    </p>
                    <!-- <button class="botao" id="btCadastrar"> -->

                        <div class="contentBtn">

                            <img src="../assetsDashboard/CadFunc.svg" alt="">
                            <p class="textoBtn">
                                Cadastrar <br>
                                Usuário
                            </p>
                        </div>
                    </button>
                </div>


            </div>


        <div class="contentContainer">

            <div class="abaContent">

            <div class="abas">
                
                <div class="aba"> Gerenciar Admins</div>
         
                
            </div>
            <div class="containerMeio">
                <div class="containerTitle">
                    <!-- <div class="titulo" id="tituloPagina">Lista de Usuários  </div> -->
                    
                    
                    <div class="containerPesquisa" id="pesquisaBar">                 
                        <input type="text" placeholder="Pesquisar Nome" oninput="search()" id="searchIpt" class="inputPesquisa">
                    
                        <button class="cadastrar" id="btCadastrar" onclick="funcaoCadastrar()">Cadastrar novo Admin</button>

                        
                    </div>

                    </div>
                    



                <div class="containerAll"  id="listaUser">

                    
                    
                    
            
                </div>
            
                <div class="containerSearch "  id="listaPesquisa">

                       
                </div>

                <div class="containerGeral" id="listaGeral">
                    <div class="textoLateral">
                        <img style="margin: 0;" src="../assetsDashboard/Info.svg" alt="">
                        <p style="font-size: 40px; padding-left: 0; ">Instruções</p>
                        <p style="padding: 0;"> Nesta tela, o administrador pode alterar as informações do usuário selecionado. Utilize os campos fornecidos para modificar os dados necessários. Após fazer as alterações desejadas, 
                            clique em "Editar" para confirmar e salvar as mudanças. Se decidir não salvar as alterações, clique em "Voltar" para retornar à tela anterior sem efetuar nenhuma modificação.</p>
                    </div>

                    <div class="contentOpt">
                
                    <div class="inputContainerEdit">
                        <p>Insira o Email:</p>
                        <input class="inputInfo" type="text" placeholder="xxxx@yyyy.com" id="novoEmailIpt">
                        <p>Insira a Senha</p>
                        <input class="inputInfo" type="password" placeholder="6 ou mais caracteres" id="novaSenhaIpt">
                        <p>Confirme a Senha:</p>
                        <input class="inputInfo" type="password" placeholder="Certifique-se que está igual">
                        <button id="editarBt" class="botaoInfo" onclick="editarFunc()">Editar</button>
                    </div>

                    <button id="voltar1" class="voltarBt" onclick="voltarFunc()">Voltar</button>
                </div>
                </div>
                    
                    <div class="containerCad" id="conCad">
                        <div class="textoLateral">
                            <img style="margin: 0;" src="../assetsDashboard/Info.svg" alt="">
                            <p style="font-size: 40px; padding-left: 0; ">Instruções</p>
                            <p style="padding: 0;"> Nesta tela, o administrador pode alterar as informações do usuário selecionado. Utilize os campos fornecidos para modificar os dados necessários. Após fazer as alterações desejadas, 
                                clique em "Editar" para confirmar e salvar as mudanças. Se decidir não salvar as alterações, clique em "Voltar" para retornar à tela anterior sem efetuar nenhuma modificação.</p>
                        </div>

                    <div class="contentOpt">
                
                        <div class="inputContainerCad">
                            <input class="inputInfo" type="text" placeholder="Nome" id="nomeFunc">
                            <input class="inputInfo" type="text" placeholder="CPF" id="cpfFunc" oninput="formatarCPF(cpfFunc)" maxlength="14" minlength="14">
                            <input class="inputInfo" type="text" placeholder="Email" id="emailFunc">
                            <input class="inputInfo" type="password" placeholder="Senha" id="senhaFunc">
                            <input class="inputInfo" type="password" placeholder="Confirmar Senha"
                                id="senhaFuncConfirm"><br>
                            <button id="cadastrarBt" class="botaoInfo" onclick="cadastrarAdmin()"> Cadastrar</button>
                        </div>

                   
                  
                    <button id="voltar2" class="voltarBt" onclick="voltarFunc()">Voltar</button>
                </div>


                </div>





            
            </div>
            </div>
            


    </main>

    <footer></footer>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    arrayGlobal = [];
    




    var nomeEmpresaSalvo = sessionStorage.NOME_DA_EMPRESA_SALVO;
    nomeEmpresa.innerHTML = `${nomeEmpresaSalvo}`;
    // nomeEmpresaLeftSide.innerHTML = `${nomeEmpresaSalvo}`;

    function formatarCPF(cpfFunc) {
    let cpf = cpfFunc.value; 
    cpf = cpf.replace(/\D/g, ''); 
    cpf = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); 
    cpfFunc.value = cpf; 
}


    function deletarAdmin(idUser) {
        Swal.fire({
            title: 'Tem certeza?',
            text: 'Ao prosseguir você excluirá permanentemente o usuário',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, excluir usuário!',
            cancelButtonText: 'Cancelar',
        }).then((result) => {

            if (result.isConfirmed) {
                fetch(`/manager/deletarAdmin/${idUser}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                    }
                })
                    .then(function (resposta) {
                        console.log("resposta: ", resposta);

                        if (resposta.ok) {
                            Swal.fire(
                                'Sucesso!',
                                'Usuário excluído com sucesso!',
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });

                        } 
                    })
                    .catch(function (resposta) {
                        console.log(`#ERRO: ${resposta}`);
                    });
            }})
        }


        function cadastrarAdmin() {
        var nomeVar = nomeFunc.value;
        var emailVar = emailFunc.value;
        var senhaVar = senhaFunc.value;
        var senhaConfirmVar = senhaFuncConfirm.value;
        var isAdminVar = 1;
        var idEmpresaVar = sessionStorage.ID_EMPRESA_SALVO;
        var cpfVar = cpfFunc.value;

        if (nomeVar == "" || emailVar == "" || senhaVar == "" || cpfVar == "") {
            Swal.fire(
                "Erro",
                "preencha todos os campos para realizar o cadastro de um novo funcionário",
                "error"
            )
            return;
        }

        if (cpfVar.length !=14) {
            Swal.fire(
                "Erro",
                "O cpf tem menos de 11 dígitos",
                "error"
            )
            return;
        }

        if (!emailVar.includes("@") && !emailVar.includes(".")) {
            Swal.fire(
                "Erro",
                "O email deve conter '@' e '.', como neste exemplo: email@example.com ",
                "error"
            )
            return;
        }

        if (senhaVar.length < 6 && senhaConfirmVar.length < 6) {
            Swal.fire(
                "Erro",
                "A senha deve conter no minímo 6 dígitos",
                "error"
            )
            return;
        }

        if (senhaVar != senhaConfirmVar) {
            Swal.fire(
                "Erro",
                "A confirmação de senha não coincide com a senha.",
                "error"
            )
            return;
        }


        fetch("/manager/cadastrarAdmin", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeServer: nomeVar,
                emailServer: emailVar,
                senhaServer: senhaVar,
                idEmpresaServer: idEmpresaVar,
                isAdminServer: isAdminVar,
                cpfServer: cpfVar
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    // Exibindo Sweet Alert de sucesso
                    Swal.fire(
                        'Sucesso!',
                        'Usuário cadastrado com sucesso!',
                        'success'
                    ).then(() => {
                        window.location.reload();
                    });
                } else if (resposta.status == 500) {
                    Swal.fire(
                        "Erro",
                        "O cpf ou email já estão em uso",
                        "error"
                    ).then(() => {
                        window.location.reload();
                    })
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }



    function revogarAdmin(idUser) {

        Swal.fire({
            title: 'Tem certeza?',
            text: 'Ao prosseguir você revogará a permissão de admin do funcionário. Clique em "Cancelar" para cancelar a operação.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, revogar!',
            cancelButtonText: 'Cancelar',
        }).then((result) => {
            if (result.isConfirmed) {


                fetch(`/manager/revogarAdmin/${idUser}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    }

                })
                    .then(function (resposta) {
                        console.log("resposta: ", resposta);

                        if (resposta.ok) {
                            Swal.fire(
                                'Sucesso!',
                                'permissão de ADMIN revogada com sucesso',
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });

                        } 
                    })
                    .catch(function (resposta) {
                        console.log(resposta)
                    });
            }
        })




    }



    function listarAdmin() {

        var idEmpresaVar = sessionStorage.ID_EMPRESA_SALVO;

        fetch("/manager/listarAdmin", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresaVar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listarFunc()!")

            if (resposta.ok) {
                console.log(resposta);
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var usuario = resposta[i];
                        arrayGlobal.push(usuario);
                        var categoria = "admin"

                        listaUser.innerHTML += `
                        
                        <div class="contentFunc">
                            <div class="contentfuncEsquerdo">
                                <span>ID: ${usuario.idUsuario}</span>
                                <span>Nome: ${usuario.nome}</span>
                                <span>Email: ${usuario.email}</span>
                                <span>CPF: ${usuario.cpf} </span>
                                <span>Permissão: ${categoria} </span>
                            </div>
                            <div class="contentfuncDireito">
                                <button class="btFunc" onclick="deletarAdmin('${usuario.idUsuario}')"><img src="../assetsDashboard/Lixeira.svg">Excluir</button>
                                <button class="btFunc" onclick="revogarAdmin('${usuario.idUsuario}')"><img src="../assetsDashboard/Revogar.svg">Revogar </button>


                            </div>
                        </div>
                    `;

                    }

                    setTimeout(function () {
                        window.location.reload
                    }, 1000);

                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");
                resposta.text().then(texto => {
                    console.error(texto, "teste");

                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function search() {
        var pesquisa = searchIpt.value.toLowerCase();
        var containerAll = document.getElementById("listaUser");
        var containerSearch = document.getElementById("listaPesquisa");

        containerAll.classList.add("hide");
        containerSearch.classList.remove("hide");
        containerSearch.innerHTML = '';

        var userFiltrados = arrayGlobal.filter(function (usuario) {
            return (
                usuario.nome.toLowerCase().includes(pesquisa)
            );
        });

        userFiltrados.forEach(function (usuario) {
            var categoria = "admin"
            listaPesquisa.innerHTML += `   
        <div class="contentFunc">
                            <div class="contentfuncEsquerdo">
                                <span>ID: ${usuario.idUsuario}</span>
                                <span>Nome: ${usuario.nome}</span>
                                <span>Email: ${usuario.email}</span>
                                <span>CPF: ${usuario.cpf} </span>
                                <span>Categoria: ${categoria} </span>
                              
                            </div>
                            <div class="contentfuncDireito">
                                <button class="btFunc" onclick="deletarAdmin('${usuario.idUsuario}')"><img src="../assetsDashboard/Lixeira.svg">Excluir</button>
                                <button class="btFunc" onclick="revogarAdmin('${usuario.idUsuario}')"><img src="../assetsDashboard/Revogar.svg">Revogar permissão</button>


                            </div>
                        </div>
                    `;
        });

        if (userFiltrados.length === 0) {
            listaPesquisa.innerHTML += `   
           usuario não encontrada`;
        }
    }

    var cpf = "541.249.558-39"
    console.log(cpf.length)

    function funcaoCadastrar(){

var containerAll = document.getElementById("listaUser");
var containerSearch = document.getElementById("listaPesquisa");
var containerGeral = document.getElementById("listaGeral");
var containerCad = document.getElementById("conCad");
var barraPesquisa = document.getElementById("pesquisaBar");

containerCad.style.display = "flex";
containerGeral.style.display = "none";
containerAll.style.display = "none";
containerSearch.style.display = "none";

barraPesquisa.innerHTML = `<p class="titulo">Cadastrar Usuário</p>`


titulo.style.textAlign = "center"
titulo.innerHTML = `<img class='iconInfo' src='../assetsDashboard/EditFuncIcon.svg'> <h1>Edição de usuários</h1>  <p id = "paragrafName">Você está editando as informações do usuário ${userNameGlobal}</p>`
paragrafName.style.textAlign = "center"

}

function voltarFunc(){

// tituloPagina.innerHTML = `Lista de Usuários <img src="./../../assets/logo-azul-claro.svg" alt="">`

var containerAll = document.getElementById("listaUser");
var containerSearch = document.getElementById("listaPesquisa");
var containerGeral = document.getElementById("listaGeral");
var barraPesquisa = document.getElementById("pesquisaBar");
var containerCad = document.getElementById("conCad");

containerCad.style.display = "none";
containerGeral.style.display = "none";
containerAll.style.display = "flex";
containerSearch.style.display = "none";
barraPesquisa.innerHTML = ` <input type="text" placeholder="Pesquisar Nome" oninput="search()" id="searchIpt"       class="inputPesquisa">
            
            <button class="cadastrar" id="btCadastrar" onclick="funcaoCadastrar()">Cadastrar novo Usuário</button>`
        
        }

</script>